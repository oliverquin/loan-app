<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Loan Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;padding:10px}
h2{text-align:center}
.tabs{text-align:center;margin-bottom:15px}
.tabs button{padding:10px;border:none;margin:3px;font-weight:bold}
.tabs button.active{background:#007bff;color:white}
.card{background:white;padding:15px;max-width:1000px;margin:auto;display:none}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#007bff;color:white}
.action{cursor:pointer;font-size:18px}
.green{background:#d4edda}
.red{background:#f8d7da}
</style>
</head>

<body>

<h2>Loan Management App</h2>

<div class="tabs">
  <button class="active" onclick="showTab('home',event)">ğŸ  Home</button>
  <button onclick="showTab('entry',event)">â• Add</button>
  <button onclick="showTab('history',event)">ğŸ“œ History</button>
</div>

<!-- HOME -->
<div id="home" class="card">
  <h3>Dashboard</h3>
  <label>Select Month</label>
  <input type="month" id="monthFilter" onchange="buildHome()">

  <p><b>Total Outstanding:</b> â‚¹ <span id="outstanding">0</span></p>
  <p><b>Interest Received:</b> â‚¹ <span id="interestMonth">0</span></p>
</div>

<!-- ENTRY -->
<div id="entry" class="card">
  <h3>Add / Edit Entry</h3>

  <input id="customerName" placeholder="Customer Name">
  <input id="loanAmount" type="number" placeholder="Loan Amount">
  <input id="interestRate" type="number" placeholder="Interest Rate">
  <input id="date" type="date">
  <input id="principalPaid" type="number" value="0">
  <input id="interestPaid" type="number" value="0">
  <input id="balancePrincipal" type="number">
  <input id="remarks" placeholder="Remarks">

  <button onclick="save()">Save</button>
</div>

<!-- HISTORY -->
<div id="history" class="card">
  <h3>History</h3>
  <table>
    <thead>
      <tr>
        <th>S.No</th>
        <th>Customer</th>
        <th>Date</th>
        <th>Interest</th>
        <th>Principal</th>
        <th>Balance</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycby8Awxah36wP12dwZeSLhW5QTTuYjMqAdfjyUllKIV7aRWyCZ42i8Yj000iTFCVF6Tl/exec";
let data=[], editId=null;

function showTab(id,e){
  ["home","entry","history"].forEach(x=>document.getElementById(x).style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  e.target.classList.add("active");
  if(id==="home") buildHome();
}

fetch(URL).then(r=>r.json()).then(d=>{
  data=d.slice(1);
  buildHistory();
  buildHome();
  document.getElementById("home").style.display="block";
});

function buildHistory(){
  const tb=document.getElementById("historyBody");
  tb.innerHTML="";
  data.forEach((r,i)=>{
    tb.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${r[0]}</td>
      <td>${r[3].substring(0,10)}</td>
      <td>${r[5]}</td>
      <td>${r[4]}</td>
      <td>${r[6]}</td>
      <td>
        <span class="action" onclick="edit('${r[8]}')">âœï¸</span>
        <span class="action" onclick="del('${r[8]}')">ğŸ—‘ï¸</span>
      </td>
    </tr>`;
  });
}

function edit(id){
  if(!confirm("Do you want to edit?")) return;
  const r=data.find(x=>x[8]==id);
  editId=id;
  customerName.value=r[0];
  loanAmount.value=r[1];
  interestRate.value=r[2];
  date.value=r[3].substring(0,10);
  principalPaid.value=r[4];
  interestPaid.value=r[5];
  balancePrincipal.value=r[6];
  remarks.value=r[7];
  showTab('entry',{target:document.querySelectorAll('.tabs button')[1]});
}

function del(id){
  if(!confirm("Do you want to delete?")) return;
  fetch(URL+"?action=delete&id="+id).then(()=>location.reload());
}

function save(){
  const p=new URLSearchParams({
    action:editId?"update":"create",
    id:editId||Date.now(),
    customerName:customerName.value,
    loanAmount:loanAmount.value,
    interestRate:interestRate.value,
    date:date.value,
    principalPaid:principalPaid.value,
    interestAmount:interestPaid.value,
    balancePrincipal:balancePrincipal.value,
    remarks:remarks.value
  });
  fetch(URL+"?"+p).then(()=>location.reload());
}

function buildHome(){
  let total=0, interest=0;
  const m=document.getElementById("monthFilter").value;
  data.forEach(r=>{
    total+=Number(r[6]);
    if(m && r[3].startsWith(m)) interest+=Number(r[5]);
  });
  outstanding.innerText=total;
  interestMonth.innerText=interest;
}
</script>

</body>
</html>
