<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loan Management App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial,sans-serif; background:#f4f6f8; padding:10px; }
h2 { text-align:center; }
.tabs { display:flex; justify-content:space-around; margin-bottom:15px; }
.tabs button { flex:1; padding:10px; margin:0 4px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; background:#ccc; color:#000; }
.tabs button.active { background:#2563eb; color:#fff; }
.card { max-width:1000px; margin:0 auto 15px; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); display:none; }
input,button,select { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
button { background:#2563eb; color:#fff; font-size:16px; border:none; cursor:pointer; }
table { width:100%; border-collapse:collapse; font-size:14px; }
th,td { padding:8px; border-bottom:1px solid #ddd; text-align:center; }
th { background:#2563eb; color:white; }
.delete-icon { cursor:pointer; color:red; font-weight:bold; font-size:16px; }
@media(max-width:600px){ table, th, td { font-size:12px; padding:6px; } .tabs button { font-size:12px; padding:8px; } }
</style>
</head>
<body>

<h2>Loan Management App</h2>

<div class="tabs">
  <button class="active" onclick="showTab('dashboard',this)">Dashboard</button>
  <button onclick="showTab('entry',this)">Add Entry</button>
  <button onclick="showTab('history',this)">History</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="card">
  <h3>Dashboard</h3>
  <label>Filter Month & Year</label>
  <input type="month" id="dashboardMonth" onchange="buildDashboard()">
  <p><strong>Total Outstanding Loan:</strong> <span id="totalLoan">0</span></p>
  <p><strong>Interest Received:</strong> <span id="interestReceived">0</span></p>
</div>

<!-- ADD ENTRY -->
<div id="entry" class="card">
  <h3>Add Entry</h3>
  <input id="customerName" placeholder="Customer Name">
  <input id="loanAmount" type="number" placeholder="Loan Amount">
  <input id="interestRate" type="number" placeholder="Interest Rate (%)">
  <input id="date" type="date">
  <input id="principalPaid" type="number" placeholder="Principal Paid (default 0)" value="0">
  <input id="interestPaid" type="number" placeholder="Interest Paid" value="0">
  <input id="balancePrincipal" type="number" placeholder="Balance Principal" readonly>
  <input id="remarks" placeholder="Remarks">
  <button onclick="saveEntry()">Save</button>
  <div id="msg"></div>
</div>

<!-- HISTORY -->
<div id="history" class="card">
  <h3>History</h3>
  <input id="filterCustomer" placeholder="Search customer" oninput="renderHistory()">
  <table>
    <thead>
      <tr>
        <th>S.No</th>
        <th>Customer</th>
        <th>Date</th>
        <th>Remarks</th>
        <th>Interest Paid</th>
        <th>Principal Paid</th>
        <th>Balance Principal</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzT2d6Q7hG8QVj6Q7XTD_cbEh7AG_UqTu3pdb3Z4ZH1UvqC3ZGVut2IHNY8HOmNM-1S/exec"; // replace with Apps Script URL
let data = [];

function showTab(id,el){
  ['dashboard','entry','history'].forEach(x=>document.getElementById(x).style.display=x===id?'block':'none');
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
  if(id==='dashboard') buildDashboard();
}

function loadData(){
  fetch(URL)
    .then(r=>r.json())
    .then(d=>{
      data = d.slice(1); // remove header
      renderHistory();
      showTab('entry',document.querySelectorAll('.tabs button')[1]);
      autoBalancePrincipal();
    });
}

function autoBalancePrincipal(){
  // calculate balance principal automatically if empty
  const cust = customerName.value;
  if(!cust) return;
  let lastBalance = 0;
  const custRows = data.filter(r=>r[0]===cust);
  if(custRows.length>0){
    lastBalance = Number(custRows[custRows.length-1][6]);
  }
  const principalPaidVal = Number(principalPaid.value||0);
  balancePrincipal.value = (lastBalance - principalPaidVal).toFixed(2);
}

// update balance principal on principal change
principalPaid.addEventListener('input',autoBalancePrincipal);

function buildDashboard(){
  let totalLoan=0, interestReceived=0;
  const lastBalances = {};
  const filter = document.getElementById('dashboardMonth').value; // format yyyy-mm
  const [filterYear,filterMonth] = filter ? filter.split('-').map(Number) : [null,null];

  data.forEach(r=>{
    const custId = r[8];
    const date = new Date(r[3]);
    if(!lastBalances[custId] || new Date(lastBalances[custId].date)<date){
      lastBalances[custId] = {balance:Number(r[6]), date:r[3]};
    }
    if(filterYear && filterMonth){
      if(date.getFullYear()===filterYear && (date.getMonth()+1)===filterMonth){
        interestReceived += Number(r[5]);
      }
    } else {
      const now = new Date();
      if(date.getFullYear()===now.getFullYear() && date.getMonth()===now.getMonth()){
        interestReceived += Number(r[5]);
      }
    }
  });

  Object.keys(lastBalances).forEach(c=> totalLoan += lastBalances[c].balance);
  document.getElementById('totalLoan').innerText = totalLoan.toFixed(2);
  document.getElementById('interestReceived').innerText = interestReceived.toFixed(2);
}

function renderHistory(){
  const filter = document.getElementById('filterCustomer').value.toLowerCase();
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML='';
  let index=1;
  data.slice().reverse().forEach(r=>{
    if(!r[0].toLowerCase().includes(filter)) return;
    const dateStr = new Date(r[3]).toISOString().split('T')[0]; // YYYY-MM-DD
    tbody.innerHTML += `<tr>
      <td>${index++}</td>
      <td>${r[0]}</td>
      <td>${dateStr}</td>
      <td>${r[7]}</td>
      <td>${r[5]}</td>
      <td>${r[4]}</td>
      <td>${r[6]}</td>
      <td><span class="delete-icon" onclick="deleteEntry('${r[9]}')">üóëÔ∏è</span></td>
    </tr>`;
  });
}

function saveEntry(){
  const lastBalance = data.filter(r=>r[0]===customerName.value).pop()?.[6] || Number(loanAmount.value||0);
  const obj = {
    customerName:customerName.value,
    loanAmount:loanAmount.value,
    interestRate:interestRate.value,
    date:date.value,
    principalPaid:principalPaid.value || 0,
    interestPaid:interestPaid.value || 0,
    balancePrincipal: lastBalance - Number(principalPaid.value||0),
    remarks:remarks.value
  };
  fetch(`${URL}?action=save&customerName=${encodeURIComponent(obj.customerName)}&loanAmount=${obj.loanAmount}&interestRate=${obj.interestRate}&date=${obj.date}&principalPaid=${obj.principalPaid}&interestPaid=${obj.interestPaid}&balancePrincipal=${obj.balancePrincipal}&remarks=${encodeURIComponent(obj.remarks)}`)
    .then(r=>r.text())
    .then(txt=>{
      resetForm();
      loadData();
      showTab('history',document.querySelectorAll('.tabs button')[2]);
    });
}

function deleteEntry(recordId){
  if(!confirm("Do you want to delete this record?")) return;
  fetch(`${URL}?action=delete&recordId=${recordId}`)
    .then(r=>r.text())
    .then(txt=>loadData());
}

function resetForm(){
  customerName.value=''; loanAmount.value=''; interestRate.value='';
  date.value=''; principalPaid.value='0'; interestPaid.value='0';
  balancePrincipal.value=''; remarks.value='';
}

const customerName = document.getElementById('customerName');
const loanAmount = document.getElementById('loanAmount');
const interestRate = document.getElementById('interestRate');
const date = document.getElementById('date');
const principalPaid = document.getElementById('principalPaid');
const interestPaid = document.getElementById('interestPaid');
const balancePrincipal = document.getElementById('balancePrincipal');
const remarks = document.getElementById('remarks');

loadData();
</script>
</body>
</html>
