<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loan Management App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; background: #f4f6f8; padding: 10px; }
h2 { text-align: center; }
form, .history, .customers {
  max-width: 600px;
  margin: 15px auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
}
label { display: block; margin-top: 10px; font-weight: bold; }
input, select {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  box-sizing: border-box;
}
button {
  margin-top: 15px;
  width: 100%;
  padding: 12px;
  font-size: 16px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
button:disabled { background: gray; }
#msg { margin-top: 10px; text-align: center; font-weight: bold; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
  font-size: 14px;
}
th { background: #007bff; color: white; }
@media(max-width:600px) {
  table, th, td { font-size: 12px; }
}
</style>
</head>
<body>

<h2>Loan Management</h2>

<form id="loanForm">
  <label>Customer Name</label>
  <input type="text" id="customerName" list="customerSuggestions" required>
  <datalist id="customerSuggestions"></datalist>

  <label>Loan Amount</label>
  <input type="number" step="0.01" id="loanAmount" required>

  <label>Interest Rate (%)</label>
  <input type="number" step="0.01" id="interestRate" required>

  <label>Date</label>
  <input type="date" id="date">

  <label>Principal Paid</label>
  <input type="number" step="0.01" id="principalPaid" value="0">

  <label>Interest Amount</label>
  <input type="number" step="0.01" id="interestAmount">

  <label>Balance Principal</label>
  <input type="number" step="0.01" id="balancePrincipal" readonly>

  <button type="submit">Save</button>
  <div id="msg"></div>
</form>

<div class="customers">
  <h3>Customer List</h3>
  <select id="customerSelect">
    <option value="">-- Select Customer --</option>
  </select>
</div>

<div class="history">
  <h3>Loan History</h3>
  <table id="historyTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Date</th>
        <th>Principal Paid</th>
        <th>Interest Paid</th>
        <th>Balance Principal</th>
        <th>Remarks</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxnKBs3d91XTvabjXESi3dA8UNDeiJoT_7r9hf9zI3-81oIfyZ8gj8CqdIOjG_wh5WD/exec";

/* ---------- Helpers ---------- */
function formatDate(dateValue) {
  const d = new Date(dateValue);
  return d.toLocaleDateString('en-CA'); // YYYY-MM-DD
}

/* ---------- Auto calculations ---------- */
function calculate() {
  const loan = parseFloat(document.getElementById("loanAmount").value) || 0;
  const principalPaid = parseFloat(document.getElementById("principalPaid").value) || 0;
  const rate = parseFloat(document.getElementById("interestRate").value) || 0;

  const balance = loan - principalPaid;
  const interest = ((balance * rate) / 100).toFixed(2);

  document.getElementById("balancePrincipal").value = balance.toFixed(2);
  document.getElementById("interestAmount").value = interest;
}

document.getElementById("loanAmount").addEventListener("input", calculate);
document.getElementById("interestRate").addEventListener("input", calculate);
document.getElementById("principalPaid").addEventListener("input", calculate);

/* ---------- Fetch data ---------- */
async function fetchData() {
  try {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();
    return data.slice(1); // remove header row
  } catch (err) {
    console.error(err);
    return [];
  }
}

/* ---------- Populate customers ---------- */
async function populateCustomerList() {
  const data = await fetchData();
  const select = document.getElementById("customerSelect");
  const datalist = document.getElementById("customerSuggestions");

  const customers = [...new Set(data.map(r => r[0]).filter(Boolean))];

  select.innerHTML = '<option value="">-- Select Customer --</option>';
  datalist.innerHTML = "";

  customers.forEach(c => {
    select.innerHTML += `<option value="${c}">${c}</option>`;
    datalist.innerHTML += `<option value="${c}">`;
  });
}

/* ---------- Display history ---------- */
async function displayHistory(customer) {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  const data = await fetchData();
  const rows = data
    .filter(r => r[0] === customer)
    .sort((a, b) => new Date(b[3]) - new Date(a[3]));

  rows.forEach((r, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${formatDate(r[3])}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td>${r[6]}</td>
      <td>${r[7] || ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("customerSelect").addEventListener("change", function () {
  const customer = this.value;
  if (customer) displayHistory(customer);
  else document.querySelector("#historyTable tbody").innerHTML = "";
});

/* ---------- Save ---------- */
document.getElementById("loanForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const params = new URLSearchParams({
    customerName: document.getElementById("customerName").value,
    loanAmount: document.getElementById("loanAmount").value,
    interestRate: document.getElementById("interestRate").value,
    date: document.getElementById("date").value,
    principalPaid: document.getElementById("principalPaid").value || 0,
    interestAmount: document.getElementById("interestAmount").value,
    balancePrincipal: document.getElementById("balancePrincipal").value
  });

  document.getElementById("msg").innerText = "Saving...";

  fetch(`${SCRIPT_URL}?${params.toString()}`)
    .then(r => r.text())
    .then(text => {
      if (text === "OK") {
        document.getElementById("msg").style.color = "green";
        document.getElementById("msg").innerText = "Saved successfully!";
        document.getElementById("loanForm").reset();
        populateCustomerList();
      } else {
        document.getElementById("msg").style.color = "red";
        document.getElementById("msg").innerText = text;
      }
    })
    .catch(err => {
      document.getElementById("msg").style.color = "red";
      document.getElementById("msg").innerText = "Error saving data";
      console.error(err);
    });
});

/* ---------- Initial load ---------- */
populateCustomerList();
</script>

</body>
</html>
