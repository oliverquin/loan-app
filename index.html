<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loan Management App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 10px;
}

h2 {
  text-align: center;
}

.tabs {
  text-align: center;
  margin-bottom: 15px;
}

.tabs button {
  padding: 10px 18px;
  margin: 0 5px;
  border: none;
  cursor: pointer;
  background: #ccc;
  border-radius: 4px;
  font-weight: bold;
}

.tabs button.active {
  background: #007bff;
  color: #fff;
}

.card {
  max-width: 900px;
  margin: 0 auto;
  background: #fff;
  padding: 15px;
  border-radius: 6px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
  display: none;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
  font-size: 14px;
}

th {
  background: #007bff;
  color: white;
}

.red {
  background-color: #f8d7da;
}

.green {
  background-color: #d4edda;
}
</style>
</head>

<body>

<h2>Loan Management</h2>

<div class="tabs">
  <button class="active" onclick="showTab('history', event)">History</button>
  <button onclick="showTab('pending', event)">Interest Pending</button>
</div>

<!-- HISTORY TAB -->
<div id="history" class="card">
  <h3>Loan History</h3>
  <table id="historyTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Date</th>
        <th>Remarks</th>
        <th>Interest Paid</th>
        <th>Principal Paid</th>
        <th>Balance Principal</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- PENDING TAB -->
<div id="pending" class="card">
  <h3>Interest Pending List</h3>
  <table id="pendingTable">
    <thead>
      <tr>
        <th>Customer</th>
        <th>Pending Months</th>
        <th>Total Pending Interest</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbyz_toAxpz3UP6CX9NSfm4h8uR0huRUvVxPwnSI77PREaDfBUdOFUfVtL6lZS8uGSGf/exec";

let rawData = [];

/* ---------- TAB SWITCH (FIXED, SAFE) ---------- */
function showTab(tabId, event) {
  const historyDiv = document.getElementById("history");
  const pendingDiv = document.getElementById("pending");

  historyDiv.style.display = tabId === "history" ? "block" : "none";
  pendingDiv.style.display = tabId === "pending" ? "block" : "none";

  document.querySelectorAll(".tabs button").forEach(btn =>
    btn.classList.remove("active")
  );

  if (event && event.target) {
    event.target.classList.add("active");
  }

  if (tabId === "pending") {
    buildPendingList();
  }
}

/* ---------- FETCH DATA ---------- */
fetch(SCRIPT_URL)
  .then(res => res.json())
  .then(data => {
    rawData = data;
    buildHistory();
    document.getElementById("history").style.display = "block";
  })
  .catch(err => console.error(err));

/* ---------- HISTORY TABLE ---------- */
function buildHistory() {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  rawData.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${r.date}</td>
      <td>${r.remarks || ""}</td>
      <td>${r.interestPaid}</td>
      <td>${r.principalPaid}</td>
      <td>${r.balancePrincipal}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- INTEREST PENDING ---------- */
function buildPendingList() {
  const map = {};

  rawData.forEach(r => {
    const key = r.customerName;
    if (!map[key]) {
      map[key] = { months: 0, amount: 0 };
    }

    if (Number(r.interestPaid) === 0) {
      map[key].months += 1;
      map[key].amount += Number(r.interestAmount || 0);
    }
  });

  const tbody = document.querySelector("#pendingTable tbody");
  tbody.innerHTML = "";

  let hasPending = false;

  Object.keys(map).forEach(name => {
    if (map[name].months > 0) {
      hasPending = true;
      const tr = document.createElement("tr");
      tr.className = "red";
      tr.innerHTML = `
        <td>${name}</td>
        <td>${map[name].months}</td>
        <td>${map[name].amount.toFixed(2)}</td>
        <td>Pending</td>
      `;
      tbody.appendChild(tr);
    }
  });

  if (!hasPending) {
    const tr = document.createElement("tr");
    tr.className = "green";
    tr.innerHTML = `
      <td colspan="4">All customers have paid interest âœ”</td>
    `;
    tbody.appendChild(tr);
  }
}
</script>

</body>
</html>
