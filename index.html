<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loan Interest Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 15px; }
  h2 { text-align: center; color: #333; margin-bottom: 10px; }
  .tabs { text-align: center; margin-bottom: 10px; }
  .tabs button {
    padding: 10px 20px;
    margin: 0 5px;
    border: none;
    background: #ddd;
    cursor: pointer;
    border-radius: 4px;
    font-size: 16px;
  }
  .tabs button.active { background: #007bff; color: white; }
  .card {
    background: white;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
    display: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
    font-size: 14px;
  }
  th { background: #007bff; color: white; }
  .red { background: #f8d7da; }
  .green { background: #d4edda; }
</style>

</head>
<body>

<h2>Loan Interest Management</h2>

<div class="tabs">
  <button class="active" onclick="showTab('history', event)">History</button>
  <button onclick="showTab('pending', event)">Interest Pending</button>
</div>

<!-- HISTORY TAB -->
<div id="history" class="card">
  <h3>Payment History</h3>
  <table id="historyTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Customer</th>
        <th>Date</th>
        <th>Remarks</th>
        <th>Interest Paid</th>
        <th>Principal Paid</th>
        <th>Balance Principal</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- PENDING TAB -->
<div id="pending" class="card">
  <h3>Interest Pending</h3>
  <table id="pendingTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Customer</th>
        <th>Unpaid Months</th>
        <th>Total Pending Interest</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyz_toAxpz3UP6CX9NSfm4h8uR0huRUvVxPwnSI77PREaDfBUdOFUfVtL6lZS8uGSGf/exec";

let rawData = [];

/* ---------------- TAB SWITCH ---------------- */
function showTab(id, event) {
  const historyTab = document.getElementById("history");
  const pendingTab = document.getElementById("pending");

  historyTab.style.display = id === "history" ? "block" : "none";
  pendingTab.style.display = id === "pending" ? "block" : "none";

  document.querySelectorAll(".tabs button").forEach(btn => btn.classList.remove("active"));
  event.target.classList.add("active");

  if (id === "pending") loadPending();
}

/* ---------------- FETCH DATA ---------------- */
async function fetchData() {
  try {
    const res = await fetch(SCRIPT_URL);
    const json = await res.json();
    rawData = json.slice(1); // Remove header row
    loadHistory();
    document.getElementById("history").style.display = "block";
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

/* ---------------- LOAD HISTORY ---------------- */
function loadHistory() {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  rawData.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${r[0]}</td>
      <td>${new Date(r[3]).toLocaleDateString("en-CA")}</td>
      <td>${r[7] || ""}</td>
      <td>${r[5]}</td>
      <td>${r[4]}</td>
      <td>${r[6]}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------------- LOAD PENDING ---------------- */
function loadPending() {
  const map = {};

  rawData.forEach(r => {
    const name = r[0];
    const month = new Date(r[3]).getFullYear() + "-" + (new Date(r[3]).getMonth() + 1);

    if (!map[name]) map[name] = {};
    if (!map[name][month]) map[name][month] = 0;

    if (Number(r[5]) === 0) {
      map[name][month] += 1;
    }
  });

  const tbody = document.querySelector("#pendingTable tbody");
  tbody.innerHTML = "";
  let index = 1;

  Object.keys(map).forEach(name => {
    const months = Object.keys(map[name]);
    const unpaidMonths = months.filter(m => map[name][m] > 0);
    let totalPending = 0;

    unpaidMonths.forEach(() => {
      const customerRows = rawData.filter(x => x[0] === name);
      const lastInterest = Math.max(...customerRows.map(x => Number(x[5]) || 0));
      totalPending += lastInterest;
    });

    if (unpaidMonths.length > 0) {
      const tr = document.createElement("tr");
      tr.className = "red";
      tr.innerHTML = `
        <td>${index++}</td>
        <td>${name}</td>
        <td>${unpaidMonths.length}</td>
        <td>${totalPending.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    }
  });

  if (!tbody.children.length) {
    const tr = document.createElement("tr");
    tr.className = "green";
    tr.innerHTML = `
      <td colspan="4">All customers are up to date!</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ---------------- START ---------------- */
fetchData();

</script>

</body>
</html>
