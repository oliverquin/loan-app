<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loan Management App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial,sans-serif; background:#f4f6f8; padding:10px; }
h2 { text-align:center; }
.tabs { display:flex; justify-content:space-around; margin-bottom:15px; }
.tabs button { flex:1; padding:10px; margin:0 4px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; background:#ccc; color:#000; }
.tabs button.active { background:#2563eb; color:#fff; }
.card { max-width:1000px; margin:0 auto 15px; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); display:none; }
input,button { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
button { background:#2563eb; color:#fff; font-size:16px; border:none; cursor:pointer; }
table { width:100%; border-collapse:collapse; font-size:14px; }
th,td { padding:8px; border-bottom:1px solid #ddd; text-align:center; }
th { background:#2563eb; color:white; }
.edit-delete { cursor:pointer; margin-left:4px; font-weight:bold; color:#2563eb; font-size:14px; }
@media(max-width:600px){ table, th, td { font-size:12px; padding:6px; } .tabs button { font-size:12px; padding:8px; } }
</style>
</head>
<body>

<h2>Loan Management App</h2>

<div class="tabs">
  <button class="active" onclick="showTab('dashboard',this)">Dashboard</button>
  <button onclick="showTab('entry',this)">Add Entry</button>
  <button onclick="showTab('history',this)">History</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="card">
  <h3>Dashboard</h3>
  <p><strong>Total Outstanding Loan:</strong> <span id="totalLoan">0</span></p>
  <p><strong>Interest Received This Month:</strong> <span id="interestReceived">0</span></p>
</div>

<!-- ADD ENTRY -->
<div id="entry" class="card">
  <h3>Add / Edit Entry</h3>
  <input id="customerName" placeholder="Customer Name">
  <input id="loanAmount" type="number" placeholder="Loan Amount">
  <input id="interestRate" type="number" placeholder="Interest Rate (%)">
  <input id="date" type="date">
  <input id="principalPaid" type="number" placeholder="Principal Paid">
  <input id="interestPaid" type="number" placeholder="Interest Paid">
  <input id="balancePrincipal" type="number" placeholder="Balance Principal">
  <input id="remarks" placeholder="Remarks">
  <button onclick="saveEntry()">Save</button>
  <div id="msg"></div>
</div>

<!-- HISTORY -->
<div id="history" class="card">
  <h3>History</h3>
  <input id="filterCustomer" placeholder="Search customer" oninput="renderHistory()">
  <table>
    <thead>
      <tr>
        <th>Customer</th>
        <th>Date</th>
        <th>Loan</th>
        <th>Principal Paid</th>
        <th>Interest Paid</th>
        <th>Balance</th>
        <th>Remarks</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<script>
let data = [], editingRecordId = null, editingCustomerId = null;

function showTab(id,el){
  ['dashboard','entry','history'].forEach(x=>document.getElementById(x).style.display=x===id?'block':'none');
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
  if(id==='dashboard') buildDashboard();
}

function loadData(){
  google.script.run.withSuccessHandler(d=>{
    data = d;
    renderHistory();
    document.getElementById('entry').style.display='block';
    document.querySelectorAll('.tabs button')[1].classList.add('active');
  }).getAllData();
}

function buildDashboard(){
  let totalLoan = 0;
  let interestReceived = 0;
  const lastBalances = {};
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  data.forEach(r=>{
    const cust = r[8]; // customerId
    const date = new Date(r[3]);
    // last balance per customer
    if(!lastBalances[cust] || new Date(lastBalances[cust].date)<date){
      lastBalances[cust] = {balance:Number(r[6]), date: r[3]};
    }
    // interest received this month
    if(date.getMonth() === currentMonth && date.getFullYear() === currentYear){
      interestReceived += Number(r[5]);
    }
  });

  Object.keys(lastBalances).forEach(c=> totalLoan += lastBalances[c].balance);
  document.getElementById('totalLoan').innerText = totalLoan.toFixed(2);
  document.getElementById('interestReceived').innerText = interestReceived.toFixed(2);
}

function renderHistory(){
  const filter = document.getElementById('filterCustomer').value.toLowerCase();
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML='';
  data.slice().reverse().forEach(r=>{
    if(!r[0].toLowerCase().includes(filter)) return;
    tbody.innerHTML += `<tr>
      <td>${r[0]}</td>
      <td>${r[3]}</td>
      <td>${r[1]}</td>
      <td>${r[4]}</td>
      <td>${r[5]}</td>
      <td>${r[6]}</td>
      <td>${r[7]}</td>
      <td>
        <span class="edit-delete" onclick="editEntry('${r[9]}','${r[8]}')">‚úèÔ∏è</span>
        <span class="edit-delete" onclick="deleteEntry('${r[9]}')">üóëÔ∏è</span>
      </td>
    </tr>`;
  });
}

function saveEntry(){
  const obj = {
    customerName:customerName.value,
    loanAmount:loanAmount.value,
    interestRate:interestRate.value,
    date:date.value,
    principalPaid:principalPaid.value || 0,
    interestPaid:interestPaid.value || 0,
    balancePrincipal:balancePrincipal.value || 0,
    remarks:remarks.value,
    customerId: editingCustomerId,
    recordId: editingRecordId
  };

  if(editingRecordId){
    if(!confirm("Do you want to save changes?")) return;
    google.script.run.withSuccessHandler(()=>{
      editingRecordId = null;
      editingCustomerId = null;
      resetForm();
      loadData();
      showTab('history',document.querySelectorAll('.tabs button')[2]);
    }).editEntry(obj);
  } else {
    google.script.run.withSuccessHandler(()=>{
      resetForm();
      loadData();
      showTab('history',document.querySelectorAll('.tabs button')[2]);
    }).saveEntry(obj);
  }
}

function editEntry(recordId,customerId){
  if(!confirm("Do you want to edit this record?")) return;
  const row = data.find(r=>r[9]===recordId);
  if(!row) return;
  customerName.value=row[0]; loanAmount.value=row[1]; interestRate.value=row[2];
  date.value=row[3]; principalPaid.value=row[4]; interestPaid.value=row[5];
  balancePrincipal.value=row[6]; remarks.value=row[7];
  editingRecordId=recordId; editingCustomerId=customerId;
  showTab('entry',document.querySelectorAll('.tabs button')[1]);
}

function deleteEntry(recordId){
  if(!confirm("Do you want to delete this record?")) return;
  google.script.run.withSuccessHandler(()=> loadData()).deleteEntry(recordId);
}

function resetForm(){
  customerName.value=''; loanAmount.value=''; interestRate.value='';
  date.value=''; principalPaid.value=''; interestPaid.value='';
  balancePrincipal.value=''; remarks.value='';
}

const customerName = document.getElementById('customerName');
const loanAmount = document.getElementById('loanAmount');
const interestRate = document.getElementById('interestRate');
const date = document.getElementById('date');
const principalPaid = document.getElementById('principalPaid');
const interestPaid = document.getElementById('interestPaid');
const balancePrincipal = document.getElementById('balancePrincipal');
const remarks = document.getElementById('remarks');

loadData();
</script>

</body>
</html>
