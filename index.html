<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Loan Manager</title>

<style>
body {
  margin: 0;
  background: #f2f4f7;
  font-family: system-ui, sans-serif;
}
.card {
  background: #fff;
  margin: 10px;
  padding: 15px;
  border-radius: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
}
h2 { margin: 0 0 10px }
input, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background: #2563eb;
  color: #fff;
  font-size: 16px;
  border: none;
}
.stat {
  font-size: 22px;
  font-weight: bold;
}
.row {
  border-bottom: 1px solid #eee;
  padding: 8px 0;
}
.small { color:#666; font-size:12px }
</style>
</head>

<body>

<!-- DASHBOARD -->
<div class="card">
  <h2>Dashboard</h2>
  <div>Total Outstanding</div>
  <div class="stat" id="outstanding">₹0</div>

  <div style="margin-top:10px">Interest Received</div>
  <div class="stat" id="interest">₹0</div>

  <input type="month" id="month" onchange="render()">
</div>

<!-- ADD ENTRY -->
<div class="card">
  <h2>Add Entry</h2>
  <input id="name" placeholder="Customer Name">
  <input id="loan" type="number" placeholder="Loan Amount">
  <input id="rate" type="number" placeholder="Interest Rate (%)">
  <input id="date" type="date">
  <input id="principal" type="number" placeholder="Principal Paid">
  <input id="interestPaid" type="number" placeholder="Interest Paid">
  <input id="remarks" placeholder="Remarks">
  <button onclick="save()">Save</button>
</div>

<!-- HISTORY -->
<div class="card">
  <h2>History</h2>
  <input placeholder="Search customer" onkeyup="filterName=this.value; render()">
  <div id="history"></div>
</div>

<script>
let data = [];
let filterName = "";

function load() {
  google.script.run.withSuccessHandler(d => {
    data = d;
    render();
  }).getAllData();
}

function render() {
  let latestBalance = {};
  let interestSum = 0;
  let month = document.getElementById("month").value;

  data.forEach(r => {
    latestBalance[r[0]] = r[6];
    if (!month || r[3].startsWith(month)) {
      interestSum += Number(r[5]);
    }
  });

  document.getElementById("outstanding").innerText =
    "₹" + Object.values(latestBalance).reduce((a,b)=>a+b,0);

  document.getElementById("interest").innerText = "₹" + interestSum;

  let html = "";
  data.slice().reverse().forEach(r => {
    if (!r[0].toLowerCase().includes(filterName.toLowerCase())) return;
    html += `
      <div class="row">
        <b>${r[0]}</b>
        <div class="small">${r[3]}</div>
        <div>Interest: ₹${r[5]}</div>
        <div>Balance: ₹${r[6]}</div>
        <div class="small">${r[7]||""}</div>
      </div>`;
  });

  document.getElementById("history").innerHTML = html;
}

function save() {
  const loan = Number(loanEl.value);
  const principal = Number(principalEl.value || 0);
  const balance = loan - principal;

  google.script.run.withSuccessHandler(() => {
    alert("Saved");
    load();
  }).saveEntry({
    name: name.value,
    loan: loan,
    rate: rate.value,
    date: date.value,
    principal: principal,
    interest: interestPaid.value,
    balance: balance,
    remarks: remarks.value
  });
}

const name = document.getElementById("name");
const loanEl = document.getElementById("loan");
const rate = document.getElementById("rate");
const date = document.getElementById("date");
const principalEl = document.getElementById("principal");
const interestPaid = document.getElementById("interestPaid");
const remarks = document.getElementById("remarks");

load();
</script>

</body>
</html>
